{
 'Реквизиты': {
  'Код': '000000001',
  'Наименование': 'Рассылка сообщений о днях рождения сорудников',
  'ТекстОбработки': '	
	//Получаем список работающих сотрудников, У кого Сегодня др	
	ТекущаяДата = ТекущаяДата();
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьЗначениеПеременной(Переменные, "ТекстЗапросаДРСотрудников");
			
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаФизическоеЛицо = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	ДРСотрудников = Новый Соответствие;
	
	Пока ВыборкаФизическоеЛицо.Следующий() Цикл
	
		ВыборкаДетальныеЗаписи = ВыборкаФизическоеЛицо.Выбрать();
	
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
				СтрокаТекст = Новый Структура;
				СтрокаТекст.Вставить("Сотрудник", ВыборкаДетальныеЗаписи.Наименование);
				СтрокаТекст.Вставить("Организация", ВыборкаДетальныеЗаписи.Организация);
				СтрокаТекст.Вставить("Подразделение", ВыборкаДетальныеЗаписи.Подразделение);
				СтрокаТекст.Вставить("Должность", ВыборкаДетальныеЗаписи.Должность);
				СтрокаТекст.Вставить("ВидЗанятости", ВыборкаДетальныеЗаписи.ВидЗанятости);
				Возвраст = Строка(ВыборкаДетальныеЗаписи.Возвраст);
				СтрокаТекст.Вставить("Юбилей", ?(Прав(Возвраст, 1) = "0" ИЛИ Прав(Возвраст, 1) = "5", Истина, Ложь));
				
				ДРСотрудника = ДРСотрудников.Получить(ВыборкаДетальныеЗаписи.ФизическоеЛицо);
				
				//Если Физ лицо работает в нескольких должностях оставляем только одну по приоретету: Основное место работы, внутреннее совместительство, внешнее совместительство, подработка.
				Если ДРСотрудника = Неопределено ИЛИ ВыборкаДетальныеЗаписи.ВидЗанятости = Перечисления.ВидыЗанятости.ОсновноеМестоРаботы Тогда
					ДРСотрудников.Вставить(ВыборкаДетальныеЗаписи.ФизическоеЛицо, СтрокаТекст);
				ИначеЕсли (ДРСотрудника.ВидЗанятости = Перечисления.ВидыЗанятости.Совместительство 
					ИЛИ ДРСотрудника.ВидЗанятости = Перечисления.ВидыЗанятости.Подработка)
					И ВыборкаДетальныеЗаписи.ВидЗанятости = Перечисления.ВидыЗанятости.ВнутреннееСовместительство Тогда
					
					ДРСотрудников.Вставить(ВыборкаДетальныеЗаписи.ФизическоеЛицо, СтрокаТекст);
					
				Иначе
					Продолжить;
				КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Если ДРСотрудников.Количество() > 0 Тогда
		
		ТекстПисьма = "<html>
			|<head>
			|<meta http-equiv=Content-Type content=""text/html; charset=windows-1251"">
			|<meta name=Generator content=""Microsoft Word 14 (filtered)"">
			|<style>
			|<!--
			| /* Font Definitions */
			| @font-face
			|	{font-family:Calibri;
			|	panose-1:2 15 5 2 2 2 4 3 2 4;}
			|@font-face
			|	{font-family:Tahoma;
			|	panose-1:2 11 6 4 3 5 4 4 2 4;}
			| /* Style Definitions */
			| p.MsoNormal, li.MsoNormal, div.MsoNormal
			|	{margin-top:0cm;
			|	margin-right:0cm;
			|	margin-bottom:10.0pt;
			|	margin-left:0cm;
			|	line-height:115%;
			|	font-size:11.0pt;
			|	font-family:""Calibri"",""sans-serif"";}
			|p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
			|	{mso-style-link:""Текст выноски Знак"";
			|	margin:0cm;
			|	margin-bottom:.0001pt;
			|	font-size:8.0pt;
			|	font-family:""Tahoma"",""sans-serif"";}
			|span.a
			|	{mso-style-name:""Текст выноски Знак"";
			|	mso-style-link:""Текст выноски"";
			|	font-family:""Tahoma"",""sans-serif"";}
			|.MsoPapDefault
			|	{margin-bottom:10.0pt;
			|	line-height:115%;}
			|@page WordSection1
			|	{size:595.3pt 841.9pt;
			|	margin:2.0cm 42.5pt 2.0cm 3.0cm;}
			|div.WordSection1
			|	{page:WordSection1;}
			|-->
			|</style>
			|</head>
			|<body lang=RU>
			|<div class=WordSection1>
			|<p class=MsoNormal><span style=\u0027font-size:12.0pt;line-height:115%;font-family: serif;\u0027>Добрый день. Сегодня " + Формат(ТекущаяДата, "ДФ=dd.MM.yyyy") + "г. дни рождения у следующих сотрудников: </span></p>";
		
		Для Каждого Элемент Из ДРСотрудников Цикл
									
			ТекстПисьма = ТекстПисьма + "<p class=MsoNormal><span style=\u0027font-size:12.0pt;line-height:115%;font-family: serif;\u0027>" + Элемент.Значение.Сотрудник + " (" + Элемент.Значение.Организация + ", " 
				+ Элемент.Значение.Подразделение + ", " + Элемент.Значение.Должность + ").</span></p>";
		КонецЦикла;
		
		ТекстПисьма = ТекстПисьма + "<p class=MsoNormal><span style=\u0027font-size:12.0pt;line-height:115%;font-family: serif;\u0027>Поздравляем наших коллег и желаем им всего самого наилучшего!</span></p>";
				
		ТекстПисьма = ТекстПисьма + "<p class=MsoNormal><span style=\u0027font-size:12.0pt;font-family: serif;line-height:115%\u0027>&nbsp;</span></p>";//+ Символы.ПС + Символы.ПС + "Поздравляем наших коллег и желаем им всего самого наилучшего!";
		
		ТекстПисьма = ТекстПисьма + Символы.ПС + Символы.ПС + "Это письмо сформировано автоматически. Пожалуйста, не отвечайте на него.";
		
		ТекстПисьма = ТекстПисьма +	"</div>
			|</body>
			|</html>";

		Получатели = "ALL_TM@tmssc.ru";//"Skryukov@data-time.ru";
		
		ПараметрыПисьма = Новый Структура;
		ПараметрыПисьма.Вставить("Кому", Получатели);
		ПараметрыПисьма.Вставить("Тема", "Дни рождения сотрудников " + Формат(ТекущаяДата, "ДФ=dd.MM.yyyy") + "г.");
		ПараметрыПисьма.Вставить("Тело", ТекстПисьма);
		ПараметрыПисьма.Вставить("ТипТекста", "HTML");
		ПараметрыПисьма.Вставить("ОбрабатыватьТексты", Ложь);
		
		Попытка
			//отправка почтового сообщения
			Идентификатор = РаботаСПочтовымиСообщениями.ОтправитьПочтовоеСообщение(РаботаСПочтовымиСообщениями.СистемнаяУчетнаяЗапись(), ПараметрыПисьма);
			
			ЗаписьЖурналаРегистрации("Рассылка ДР сотрудников " + Получатели, УровеньЖурналаРегистрации.Информация,,, ?(ЗначениеЗаполнено(Идентификатор), "Рассылка ДР отправлена", "Рассылка ДР не отправлена"));
			
		Исключение
			
			ЗаписьЖурналаРегистрации("Рассылка ДР сотрудников " + Получатели, УровеньЖурналаРегистрации.Ошибка,,,ОписаниеОшибки());
			//СтрокаОшибок = СтрокаОшибок + ?(СтрокаОшибок="","",Символы.ПС) + ОписаниеОшибки();
			
		КонецПопытки;
		
	Иначе
		
		ЗаписьЖурналаРегистрации("Рассылка ДР сотрудников", УровеньЖурналаРегистрации.Информация,,, Формат(ТекущаяДата, "ДФ=dd.MM.yyyy") + "г. Нет дней рождений у сотрудников.");
		
	КонецЕсли;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'ТекстЗапросаДРСотрудников',
     'Разделитель': null,
     'ЗначениеСтрока': 'ВЫБРАТЬ
	ФизическиеЛица.Ссылка КАК ФизическоеЛицо,
	ФизическиеЛица.Наименование КАК Наименование,
	ФизическиеЛица.ДатаРождения КАК ДатаРождения,
	РАЗНОСТЬДАТ(ФизическиеЛица.ДатаРождения, &ТекущаяДата, ГОД) КАК Возвраст
ПОМЕСТИТЬ ВТ_ФизическиеЛица
ИЗ
	Справочник.ФизическиеЛица КАК ФизическиеЛица
ГДЕ
	НЕ ФизическиеЛица.ЭтоГруппа
	И ДОБАВИТЬКДАТЕ(ФизическиеЛица.ДатаРождения, ГОД, РАЗНОСТЬДАТ(ФизическиеЛица.ДатаРождения, &ТекущаяДата, ГОД)) = &ТекущаяДата

ИНДЕКСИРОВАТЬ ПО
	ФизическиеЛица.Ссылка,
	ДатаРождения
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_ФизическиеЛица.ФизическоеЛицо КАК ФизическоеЛицо,
	ВТ_ФизическиеЛица.Наименование КАК Наименование,
	ВТ_ФизическиеЛица.ДатаРождения КАК ДатаРождения,
	ВТ_ФизическиеЛица.Возвраст КАК Возвраст,
	КадроваяИсторияСотрудниковИнтервальный.Организация КАК Организация,
	КадроваяИсторияСотрудниковИнтервальный.Подразделение КАК Подразделение,
	КадроваяИсторияСотрудниковИнтервальный.Должность КАК Должность,
	КадроваяИсторияСотрудниковИнтервальный.ДолжностьПоШтатномуРасписанию КАК ДолжностьПоШтатномуРасписанию,
	ВидыЗанятостиСотрудниковИнтервальный.ВидЗанятости КАК ВидЗанятости
ИЗ
	ВТ_ФизическиеЛица КАК ВТ_ФизическиеЛица
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КадроваяИсторияСотрудниковИнтервальный КАК КадроваяИсторияСотрудниковИнтервальный
			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВидыЗанятостиСотрудниковИнтервальный КАК ВидыЗанятостиСотрудниковИнтервальный
			ПО (ВидыЗанятостиСотрудниковИнтервальный.Сотрудник = КадроваяИсторияСотрудниковИнтервальный.Сотрудник)
		ПО ВТ_ФизическиеЛица.ФизическоеЛицо = КадроваяИсторияСотрудниковИнтервальный.ФизическоеЛицо
ГДЕ
	КадроваяИсторияСотрудниковИнтервальный.ДатаОкончания >= &ТекущаяДата
	И КадроваяИсторияСотрудниковИнтервальный.ДатаНачала <= &ТекущаяДата
	И ВидыЗанятостиСотрудниковИнтервальный.ДатаНачала <= &ТекущаяДата
	И ВидыЗанятостиСотрудниковИнтервальный.ДатаОкончания >= &ТекущаяДата
	И КадроваяИсторияСотрудниковИнтервальный.ВидСобытия <> ЗНАЧЕНИЕ(Перечисление.ВидыКадровыхСобытий.Увольнение)

УПОРЯДОЧИТЬ ПО
	Наименование
ИТОГИ ПО
	ФизическоеЛицо',
     'Комментарий': ''
    }
   ]
  }
 ]
}
